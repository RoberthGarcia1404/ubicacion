<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Cultivos - Papa y Cebolla</title>
    <link rel="stylesheet" href="styles.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>

<body>

   <div id="permisoUbicacion">
  <div>
    <h3> Activar permisos de ubicaci贸n</h3>
    <p>
      Para poder mostrar tu ubicaci贸n actual en el mapa, debes activar los permisos de ubicaci贸n
      en tu navegador o aplicaci贸n.
    </p>
    <button onclick="abrirPermisos()" class="btn-permisos">
      Abrir configuraci贸n de permisos
    </button>
  </div>
</div>

<style>
/* Estilos del modal */
#permisoUbicacion {
  display: none; /* oculto por defecto */
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999; /*  m谩s alto que el mapa */
}

#permisoUbicacion > div {
  background: white;
  padding: 20px;
  border-radius: 10px;
  max-width: 90%;
  text-align: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

#permisoUbicacion h3 {
  margin-bottom: 10px;
}

.btn-permisos {
  margin-top: 10px;
  padding: 10px 15px;
  border: none;
  border-radius: 5px;
  background: #007bff;
  color: white;
  font-size: 16px;
  cursor: pointer;
}
</style>



    <div class="container">
        <header>
            <h1> Asistente de Cultivos</h1>
            <p class="subtitle">Obt茅n recomendaciones de suelo para papa y cebolla</p>
        </header>
        <div id="info-ubicacion" class="location-info oculto">
            <div class="location-icon"></div>
            <div class="location-details">
                <p><strong>Ubicaci贸n detectada:</strong></p>
                <div class="coordinates" id="coordenadas">Cargando...</div>
                <p class="accuracy" id="precision">Precisi贸n: calculando...</p>
                <div class="gps-status" id="gps-status">
                    <span class="indicador-estado" id="indicador-estado"></span>
                    <span id="texto-estado">Evaluando precisi贸n del GPS...</span>
                </div>
            </div>
        </div>






        <div id="map" style="height:300px; margin-top:15px; border-radius:8px;" class="oculto"></div>



        <div class="content">
            <button id="btn-ubicacion"> Obtener mi ubicaci贸n autom谩ticamente</button>
            <div id="caja-error" class="error-box oculto">
                <strong>Error:</strong> <span id="mensaje-error"></span>
                <button class="retry-btn" id="btn-reintentar">Reintentar</button>
            </div>
            <div id="info-ubicacion" class="location-info oculto">
                <div class="location-icon"></div>
                <div class="location-details">
                    <p><strong>Ubicaci贸n detectada:</strong></p>
                    <div class="coordinates" id="coordenadas">Cargando...</div>
                    <p class="accuracy" id="precision">Precisi贸n: calculando...</p>
                    <div class="gps-status" id="gps-status">
                        <span class="indicador-estado" id="indicador-estado"></span>
                        <span id="texto-estado">Evaluando precisi贸n del GPS...</span>
                    </div>
                </div>
            </div>
            <div id="cargando" class="loading oculto">
                <div class="loading-spinner"></div>
                <p> Obteniendo datos del suelo desde ISRIC SoilGrids...</p>
                <p>Esto puede tomar unos segundos</p>
            </div>
            <div id="resultados" class="results oculto">
                <h2> An谩lisis de Suelo y Recomendaciones</h2>
                <div id="datos-suelo" class="soil-data">
                    <!-- Los datos reales del suelo se insertar谩n aqu铆 -->
                </div>
                <div class="crop-card">
                    <h3 class="crop-title"><span></span> Cultivo de Papa</h3>
                    <div class="soil-property">
                        <span class="property-name">pH ideal:</span> 5.5 - 6.5
                    </div>
                    <div class="soil-property">
                        <span class="property-name">Textura ideal:</span> Franco-arenosa
                    </div>
                    <div class="soil-property">
                        <span class="property-name">Materia org谩nica:</span> Alta (3-4%)
                    </div>
                    <div class="soil-property">
                        <span class="property-name">Drenaje:</span> Bueno, evitar encharcamientos
                    </div>
                    <div class="recommendation">
                         <strong>Tip:</strong> Para mejorar el rendimiento, aseg煤rate de un buen drenaje y rotaci贸n de
                        cultivos. La papa es sensible al pH muy alto.
                    </div>
                </div>
                <div class="crop-card">
                    <h3 class="crop-title"><span></span> Cultivo de Cebolla</h3>
                    <div class="soil-property">
                        <span class="property-name">pH ideal:</span> 6.0 - 7.0
                    </div>
                    <div class="soil-property">
                        <span class="property-name">Textura ideal:</span> Franco-arcillosa
                    </div>
                    <div class="soil-property">
                        <span class="property-name">Materia org谩nica:</span> Media (2-3%)
                    </div>
                    <div class="soil-property">
                        <span class="property-name">Drenaje:</span> Bueno, suelos bien estructurados
                    </div>
                    <div class="recommendation">
                         <strong>Tip:</strong> La cebolla prefiere suelos bien drenados con buena exposici贸n solar.
                        Tolera mejor los suelos ligeramente alcalinos que la papa.
                    </div>
                </div>
                <div id="analisis-compatibilidad" class="compatibility-analysis">
                    <h3 style="color: #007bff;"> An谩lisis de Compatibilidad del Suelo</h3>
                    <div id="contenido-compatibilidad">
                        <!-- El an谩lisis de compatibilidad se insertar谩 aqu铆 -->
                    </div>
                </div>
                <button class="improve-btn" id="btn-mejorar"> Mejorar precisi贸n de ubicaci贸n</button>
            </div>
        </div>
        <footer>
            <p> Usa esta herramienta para planificar tus cultivos de papa y cebolla</p>
            <p>漏 2023 - Asistente Agr铆cola | Datos de suelo: ISRIC SoilGrids</p>
        </footer>
    </div>


    <script src="app.js"></script>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Crear el mapa
        const map = L.map('map').setView([0, 0], 15);

        // Agregar capa de mapa (tiles de OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>'
        }).addTo(map);

        // Marcador para la ubicaci贸n
        let marker;

        // Opciones de geolocalizaci贸n para m谩s precisi贸n
        const options = {
            enableHighAccuracy: true, // GPS en lugar de WiFi
            timeout: 10000, // esperar m谩ximo 10 seg
            maximumAge: 0 // no usar cache
        };

        // Funci贸n de 茅xito
        function success(pos) {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            const accuracy = pos.coords.accuracy; // en metros

            // Centrar el mapa
            map.setView([lat, lon], 18);

            // Si no existe el marcador lo crea, si existe lo actualiza
            if (!marker) {
                marker = L.marker([lat, lon]).addTo(map)
                    .bindPopup(` Est谩s aqu铆<br>Precisi贸n: ${accuracy.toFixed(1)} m`)
                    .openPopup();
            } else {
                marker.setLatLng([lat, lon])
                    .setPopupContent(` Est谩s aqu铆<br>Precisi贸n: ${accuracy.toFixed(1)} m`);
            }
        }

        // Funci贸n de error
        function error(err) {
            console.error(`ERROR(${err.code}): ${err.message}`);
            alert("No se pudo obtener tu ubicaci贸n. Revisa permisos del GPS.");
        }

        // Seguir en tiempo real la ubicaci贸n
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(success, error, options);
        } else {
            alert("Tu navegador no soporta geolocalizaci贸n.");
        }
    </script>

<script>
function mostrarPermisoUbicacion() {
  document.getElementById("permisoUbicacion").style.display = "flex";
}

function abrirPermisos() {
  alert(" Abre la configuraci贸n del navegador o de la app para permitir el acceso a la ubicaci贸n.\n\nEn m贸viles, busca 'Permisos' > 'Ubicaci贸n'.");
  // En apps Android/iOS se puede intentar con:
  // window.location.href = "app-settings:";
}
</script>
</body>

</html>
